#!/usr/bin/env ruby

require_relative 'lib/spv.rb'
require 'commander/import'

program :name, 'Soft Proof Viewer - Command Line Interface'
program :version, '0.0.1'
program :description, 'Offline cache preparation utillity for Soft Proofing Viewer (SPV).'

$app = 'sample'

global_option('-a', '--app <APP>', String, "Use application namespace") do |app|
  $app = app
end

global_option('-o','--output <json|jsonp|short>', String, "Force output data to be formatted, override application configuration") do |type|
  $type = type
end

command :check do |c|
  c.syntax = 'spv-cli check'
  c.summary = 'Checks all required library and dependencies.'
  c.description = 'Some libraries may be missing and we find out which one.'
  c.example 'Run checks', 'spv-cli check'
  c.option '-n', '--name NAME', String, "Specify Namespace"
  c.action do |args, options|
  end
end

command :add do |c|
  c.syntax = 'spv-cli add -a <APP> [-s <SEL>] [-i <IDS>] <SOURCE_DOCUMENT>'
  c.summary = 'Adds page version to the cache, creates page if not present.'
  c.description = 'Page is verfied and checked before it is added, the output from the command is JSON (unless other format is specified.)'
  c.option '-s', '--sel SEL', String, "Page selection from the source document."
  c.option '-i', '--ids IDS', String, "Comma separated list of page IDS to be assgined to."
  c.action do |args, options|
    p = SPV::Processor.new($app)
    raise "No source document specified" if args[0].nil?
    p.add( args[0], options.sel, SPV::parse_ids(options.ids, false) )
    p.process_queue
    p.output($type)
  end
end

command :delete do |c|
  c.syntax = 'spv-cli delete -a <APP> -i <IDS> | <IDS>'
  c.option '-i', '--ids IDS', String, "Comma separated list of page IDS to be deleted."
  c.action do |args, options|
    p = SPV::Processor.new($app)
    p.del(SPV::parse_ids(options.ids || args[0].to_s))
    p.output($type)
  end
end

command :get do |c|
  c.syntax = 'spv-cli get -a <APP> -i <IDS> | <IDS>'
  c.option '-i', '--ids IDS', String, "Comma separated list of page IDS to be listed."
  c.action do |args, options|
    p = SPV::Processor.new($app)
    p.get(SPV::parse_ids(options.ids || args[0].to_s))
    p.output($type)
  end
end

command :list do |c|
  c.syntax = 'spv-cli list -a <APP> [-p <PATTERN>]'
  c.option "-p", "--pattern PATTERN", String, "Pattern"
  c.description = %Q[List all pages matching the pattern that exists in the application namespace. Default pattern match all files collected.]
  c.summary = %Q[List all pages in the system for the application namespace]
  c.action do |args, options|
    pattern = options.pattern || "*"
    p = SPV::Processor.new($app)
    p.list(pattern)
    p.output($type)
  end
end

command :intent do |c|

end

command :run do |c|
  c.syntax = 'spv-cli run'
  c.summary = 'Lanuches the sidekiq worker to perform conversion process in the background (requires Redis).'
  c.description = 'The redis must be installed in order to run background processing'
  c.option '-d', '--deamonize', "Execute in the background"
  c.option '-l', '--log FILE', String, "Output log to the file instead standard output"
  c.example 'Run sidekiq and perform opertions.', 'spv-cli run'
  c.action do |args, options|
    system "bundle exec sidekiq -r ./lib/spv/spv_worker.rb"
  end
end
